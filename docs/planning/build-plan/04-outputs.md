# Phase 3: Outputs (Week 7)

**Goal**: Decision briefs display, edit, share, and export to PDF.

**Status**: ‚è≥ Not Started

> **Architecture Reference**: See [CORE_JOURNEY.md](../../specs/CORE_JOURNEY.md) Step 8 and [LLM_ORCHESTRATION.md](../../specs/LLM_ORCHESTRATION.md) for brief generation.

---

## Pre-Phase Checklist

Before starting this phase, verify:

- [ ] Phase 2 (AI Analysis) complete - briefs are generated by `generateBrief` Inngest function
- [ ] `briefs` table exists (migration 009_briefs.sql)
- [ ] `outputs` table exists with `is_shared`, `share_key` columns (migration 001_initial_schema.sql)
- [ ] Build succeeds with no TypeScript errors

---

## Existing Files Reference

### DO NOT RECREATE - These files already exist:

```
src/lib/auth/require-org-context.ts     # Auth pattern for API routes
src/lib/supabase/server.ts              # Supabase client
src/lib/inngest/functions/generate-brief.ts  # Brief generation (Phase 2)
supabase/migrations/009_briefs.sql      # briefs table
supabase/migrations/001_initial_schema.sql   # outputs table with share_key
```

### Standard Auth Pattern for API Routes:

```typescript
import { requireOrgContext } from '@/lib/auth/require-org-context'

export async function GET() {
  const ctx = await requireOrgContext()
  if (!ctx.ok) return ctx.errorResponse
  const { supabase, orgId, user } = ctx

  // Your logic here...
}
```

### Error Response Pattern:

```typescript
return NextResponse.json(
  { error: { code: 'ERROR_CODE', message: 'Human readable message' } },
  { status: 400 }
)
```

### Database Tables:

**briefs** (stores generated brief content):
- `id`, `decision_id`, `sections` (JSONB), `citations` (JSONB), `markdown`, `generated_at`

**outputs** (legacy table, but has sharing fields):
- `id`, `decision_id`, `type`, `status`, `content`, `is_shared`, `share_key`

> **Note**: Phase 2 writes to `briefs` table. For sharing, we'll add `is_shared` and `share_key` directly to `briefs` table via migration.

---

## Overview: Brief Generation in v2

In the evidence-first architecture, briefs are generated as the **final step of analysis** (Step 8 in Phase 2), not as a separate action. The brief synthesizes:

- Decision framing (question, constraints, stakes)
- Options considered (all options with rationale)
- Evidence summary (key evidence with citations)
- Assumptions ledger (declared, implicit, status)
- Recommendation (primary + hedge + confidence)
- Decision changers (conditions that would flip recommendation)
- Open questions (unresolved unknowns)

This phase focuses on **displaying, editing, sharing, and exporting** the generated brief.

---

## 3.0 Database Migration for Sharing

**Windsurf Prompt:**
```
GOAL: Add sharing columns to briefs table.

FILES TO CREATE:
- supabase/migrations/010_brief_sharing.sql

SQL:
ALTER TABLE briefs ADD COLUMN IF NOT EXISTS is_shared BOOLEAN DEFAULT FALSE;
ALTER TABLE briefs ADD COLUMN IF NOT EXISTS share_key TEXT UNIQUE;
ALTER TABLE briefs ADD COLUMN IF NOT EXISTS is_edited BOOLEAN DEFAULT FALSE;

CREATE INDEX IF NOT EXISTS idx_briefs_share_key ON briefs(share_key) WHERE share_key IS NOT NULL;

CONSTRAINTS:
- Migration must be idempotent (IF NOT EXISTS)
- share_key should be unique and indexed

ACCEPTANCE CRITERIA:
- Migration runs without error
- briefs table has is_shared, share_key, is_edited columns
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª Migration file | Adds sharing columns | |
| üíª Run migration | Columns exist in database | |

---

## 3.1 Brief Display (Week 7)

**Windsurf Prompt:**
```
GOAL: Create brief display page and components to show generated brief.

FILES TO CREATE:
- src/app/(dashboard)/decisions/[id]/brief/page.tsx
- src/components/outputs/brief-header.tsx
- src/components/outputs/brief-section.tsx
- src/components/outputs/evidence-citation.tsx
- src/components/outputs/decision-changers-list.tsx

BEHAVIOR:

1. Brief page (page.tsx):
   - Use Next.js 15 async params pattern: `{ params }: { params: Promise<{ id: string }> }`
   - Fetch brief from briefs table by decision_id
   - If no brief exists, show "Analysis not complete" message with link back to results
   - Pass brief data to child components

2. Brief header (brief-header.tsx):
   - Show decision title
   - Show "Generated on [date]"
   - Show "Edited" badge if is_edited = true
   - Include action buttons placeholder (edit, share, export - built in later sections)

3. Brief section (brief-section.tsx):
   - Collapsible section with title
   - Renders markdown content
   - Props: { title: string, content: string, defaultOpen?: boolean }
   - First section (recommendation) default open, others collapsed

4. Evidence citation (evidence-citation.tsx):
   - Clickable citation badge [1], [2], etc.
   - On click, scrolls to/highlights the source
   - Shows source URL on hover

5. Decision changers list (decision-changers-list.tsx):
   - Fetch from decision_changers table
   - Show type icon (market, tech, regulatory, competitive, internal)
   - Show description and likelihood

CONSTRAINTS:
- Use existing shadcn components (Card, Badge, Collapsible, Button)
- Brief is READ-ONLY in this step (editing added in 3.2)
- Handle loading and error states

ACCEPTANCE CRITERIA:
- Brief page loads at /decisions/[id]/brief
- All 7 sections display (or as many as exist in data)
- Citations are clickable
- Collapsible sections work
- Build succeeds

‚ö†Ô∏è CANNOT FULLY TEST UNTIL: Phase 2 pipeline generates a real brief
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª Brief page route | `/decisions/[id]/brief` works | |
| üíª Brief header | Shows title, date, edit badge | |
| üíª Brief sections | Collapsible, renders markdown | |
| üíª Evidence citations | Clickable source links | |
| üíª Decision changers | Listed with icons | |

---

## 3.2 Brief Editing (Week 7)

**Windsurf Prompt:**
```
GOAL: Allow users to edit the brief narrative (markdown) while preserving structure.

FILES TO CREATE:
- src/components/outputs/brief-editor.tsx
- src/app/api/decisions/[id]/brief/route.ts

BEHAVIOR:

1. Brief API route (route.ts):
   - GET: Fetch brief by decision_id (use requireOrgContext pattern)
   - PATCH: Update brief markdown content
     - Set is_edited = true when content changes
     - Only allow updating 'markdown' field, not sections/citations
   - Verify decision belongs to user's org before allowing access

2. Brief editor (brief-editor.tsx):
   - Toggle between view and edit mode
   - Use textarea or simple markdown editor for editing
   - Preview button to see rendered markdown
   - Save and Cancel buttons
   - Show "Edited" badge after saving changes

3. Integration with brief page:
   - Add "Edit" button to brief-header.tsx
   - Button toggles edit mode
   - On save, refetch brief data

CONSTRAINTS:
- Users can edit the narrative but NOT the underlying data (evidence, scores)
- Track if brief has been manually edited (is_edited flag)
- Use requireOrgContext() for auth
- Keep editor simple - no rich text, just markdown

ACCEPTANCE CRITERIA:
- Can toggle edit mode on brief page
- Can edit markdown content
- Save persists to database
- "Edited" badge appears after modification
- Build succeeds
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª GET /api/decisions/[id]/brief | Returns brief data | |
| üíª PATCH /api/decisions/[id]/brief | Updates markdown | |
| üíª Edit toggle | Switch view/edit mode | |
| üíª Save edits | Persists to database | |
| üíª Edited badge | Shows when is_edited = true | |

---

## 3.3 Brief Sharing (Week 7)

**Windsurf Prompt:**
```
GOAL: Allow users to share briefs via public link.

FILES TO CREATE:
- src/components/outputs/share-toggle.tsx
- src/components/outputs/copy-link-button.tsx
- src/app/api/decisions/[id]/share/route.ts
- src/app/(public)/share/[key]/page.tsx

BEHAVIOR:

1. Share API route (route.ts):
   - POST: Enable sharing
     - Generate unique share_key (nanoid or uuid)
     - Set is_shared = true on briefs table
     - Return share URL
   - DELETE: Disable sharing
     - Set is_shared = false
     - Clear share_key
   - Use requireOrgContext() for auth

2. Share toggle (share-toggle.tsx):
   - Switch component to enable/disable sharing
   - Shows current sharing status
   - Calls POST/DELETE on toggle

3. Copy link button (copy-link-button.tsx):
   - Only visible when is_shared = true
   - Copies share URL to clipboard
   - Shows "Copied!" feedback

4. Public share page (page.tsx in (public) route group):
   - NO AUTH REQUIRED - this is public
   - Fetch brief by share_key (not decision_id)
   - If share_key not found or is_shared = false, show 404
   - Display read-only brief with nice formatting
   - Hide any internal/private sections
   - Show "Shared from Plinth" footer

CONSTRAINTS:
- Public page must work without authentication
- Share key should be URL-safe (no special chars)
- Revoking share should immediately invalidate the link
- Use (public) route group to avoid dashboard layout

ACCEPTANCE CRITERIA:
- Can enable sharing via toggle
- Share URL is generated and copyable
- Public page displays brief at /share/[key]
- Revoking sharing invalidates the link
- Build succeeds
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª POST /api/decisions/[id]/share | Enables sharing, returns URL | |
| üíª DELETE /api/decisions/[id]/share | Disables sharing | |
| üíª Share toggle | Enable/disable switch | |
| üíª Copy link button | Copies URL to clipboard | |
| üíª Public share page | `/share/[key]` works without auth | |
| üíª Revoke works | Disabled link returns 404 | |

---

## 3.4 PDF Export (Week 7)

**Windsurf Prompt:**
```
GOAL: Export brief as downloadable PDF.

FILES TO CREATE:
- src/components/outputs/export-pdf-button.tsx
- src/lib/pdf/generate-brief-pdf.ts
- src/app/api/decisions/[id]/brief/pdf/route.ts

BEHAVIOR:

1. PDF generation library choice:
   - Use @react-pdf/renderer for server-side PDF generation
   - Alternative: jspdf if react-pdf has issues

2. PDF generator (generate-brief-pdf.ts):
   - Takes brief data as input
   - Renders all sections in order
   - Citations as footnotes at end
   - Decision changers section
   - Simple, professional formatting
   - Returns PDF as Buffer

3. PDF API route (route.ts):
   - GET: Generate and return PDF
   - Use requireOrgContext() for auth
   - Set Content-Disposition header for download
   - Filename: `[decision-title]-brief.pdf`

4. Export button (export-pdf-button.tsx):
   - Button that triggers PDF download
   - Shows loading state while generating
   - Opens PDF in new tab or triggers download

CONSTRAINTS:
- PDF should be readable and professional
- Include all brief sections
- Citations should be numbered footnotes
- Handle long content gracefully (page breaks)

ACCEPTANCE CRITERIA:
- Export button visible on brief page
- Clicking triggers PDF download
- PDF contains all brief sections
- Citations appear as footnotes
- Build succeeds

‚ö†Ô∏è NOTE: PDF generation can be complex. If @react-pdf/renderer causes issues, fall back to simpler approach (html-to-pdf service or jspdf).
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª PDF generation util | Creates PDF from brief data | |
| üíª GET /api/.../pdf | Returns PDF file | |
| üíª Export button | Triggers download | |
| üíª PDF formatting | All sections, footnotes | |

---

## 3.5 Re-run Analysis (Week 7)

**Windsurf Prompt:**
```
GOAL: Allow users to re-run analysis to get updated brief.

FILES TO CREATE:
- src/components/outputs/rerun-analysis-button.tsx
- src/app/api/decisions/[id]/rerun/route.ts

BEHAVIOR:

1. Re-run API route (route.ts):
   - POST: Trigger new analysis
   - Use requireOrgContext() for auth
   - Verify decision belongs to user's org
   - Call inngest.send('decision/analyze', { decisionId })
   - Return job ID or success status

2. Re-run button (rerun-analysis-button.tsx):
   - Button with refresh icon
   - Shows confirmation dialog before re-running
   - Warning: "This will replace current results"
   - On confirm, calls POST endpoint
   - Redirects to results page to show progress

3. Confirmation modal:
   - Title: "Re-run Analysis?"
   - Body: "This will run a fresh analysis and replace current results. Your edited brief content will be lost."
   - Buttons: "Cancel" / "Re-run Analysis"

CONSTRAINTS:
- Must confirm before re-running (destructive action)
- Keep original decision frame and context
- Clear old evidence, options, recommendation, brief
- Use existing Inngest analyzeDecision function

ACCEPTANCE CRITERIA:
- Re-run button visible on brief page
- Confirmation dialog appears
- Confirming triggers new analysis
- User redirected to see progress
- Build succeeds

‚ö†Ô∏è CANNOT FULLY TEST UNTIL: Full pipeline is configured with API keys
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª POST /api/decisions/[id]/rerun | Triggers new analysis | |
| üíª Re-run button | Shows on brief page | |
| üíª Confirmation modal | Warns about replacement | |
| üíª Redirect | Goes to results page | |

---

## 3.6 Brief Page Integration (Week 7)

**Windsurf Prompt:**
```
GOAL: Integrate all brief components into cohesive page with action bar.

FILES TO UPDATE:
- src/app/(dashboard)/decisions/[id]/brief/page.tsx
- src/components/outputs/brief-header.tsx

BEHAVIOR:

1. Update brief header to include action bar:
   - Edit button (toggles edit mode)
   - Share toggle (enable/disable + copy link)
   - Export PDF button
   - Re-run Analysis button
   - Buttons arranged in horizontal row

2. Brief page state management:
   - Track edit mode state
   - Track sharing status
   - Refetch brief after edits or re-run

3. Layout:
   - Header with actions at top
   - Brief sections below
   - Sticky header on scroll (optional)

CONSTRAINTS:
- All buttons should show loading states
- Disable actions while loading
- Mobile-responsive button layout

ACCEPTANCE CRITERIA:
- All action buttons visible in header
- Edit, Share, Export, Re-run all functional
- Page looks polished and professional
- Build succeeds
```

| Task | Acceptance Criteria | Status |
|------|---------------------|--------|
| üíª Action bar | All 4 actions in header | |
| üíª State management | Edit mode, sharing status | |
| üíª Responsive layout | Works on mobile | |

---

## Phase 3 Milestone

**Briefs display, edit, share, export to PDF.**

### Checklist
- [ ] Brief page displays all sections from generated brief
- [ ] Citations are clickable and link to sources
- [ ] Decision changers clearly visible
- [ ] Can edit brief narrative (markdown)
- [ ] Shows "Edited" badge when modified
- [ ] Can enable/disable public sharing
- [ ] Public share page works without auth
- [ ] Can copy share link to clipboard
- [ ] Can export brief to PDF
- [ ] PDF includes all sections with citations
- [ ] Can re-run analysis to update brief

### What CAN Be Tested Without Full Setup
- [ ] TypeScript compiles for all new files
- [ ] Brief page renders with mock/empty data
- [ ] Edit mode toggle works
- [ ] Share toggle UI works
- [ ] PDF export button triggers (may fail without data)
- [ ] Re-run button and confirmation modal work
- [ ] Public share page renders

### What REQUIRES Full Setup
- [ ] Displaying real brief content (needs Phase 2 pipeline)
- [ ] Actual PDF with content (needs brief data)
- [ ] Re-run actually regenerating (needs API keys)
- [ ] Full end-to-end sharing flow

---

## Debugging Notes

*Add notes here as you work through this phase:*

```
<!-- Example:
2024-02-10: PDF generation failing on Vercel
- Issue: @react-pdf/renderer memory limits
- Fix: Switched to puppeteer-based generation
-->
```

---

**Previous Phase:** [03-ai-analysis.md](./03-ai-analysis.md)
**Next Phase:** [05-team-polish.md](./05-team-polish.md)
